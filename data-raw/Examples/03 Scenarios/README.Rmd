---
output: github_document
title:  Sensitivity runs
---

<!-- README.md is generated from README.Rmd. Please edit that file -->
The model can be run a number of times to support sensitivity analysis. Here, the package **purrr** is used to generate a large output data set (which is essentially a collation of all the individual runs, with a new ID added to the table so that the primary key is {RunNumber, SimDay})


* First, load in the libraries.

```{r}
library(seirR)
library(ggplot2)
library(purrr)
library(dplyr)
```

* Create the model, and set the physical distancing option

```{r}
mod <- create_seir_p()
mod <- set_param(mod,"distancing_flag",1)
```


* Set the sensitivity parameter ranges, and the number of runs. Packages such as FME can be used for this,
as it supports a wider range of random number generations. https://cran.r-project.org/web/packages/FME/index.html

```{r}
NRUNS <- 10

lower <- 0.2
upper <- 0.8
percentages    <- runif(NRUNS,.1,.9)
f_asymptomatic <- runif(NRUNS,.15,.7)
```

* Write a script to run the model a number of times, sampling from the random number streams

```{r}
res_full <- map_df(1:NRUNS, function(i){
  cat("iteration = ", i, "with percentage = ", percentages[i], " and f = ",f_asymptomatic[i],"\n")
  mod <- set_param(mod,"pd_percentage_reduction",percentages[i])
  mod <- set_param(mod,"prop_asymptomatic",f_asymptomatic[i])
  out2 <- run(mod) %>% mutate(RunNumber=i) %>%
     select(RunNumber,everything())
})
```

* Show all the results for one of the variables
```{r}
ggplot(res_full,aes(x=Date,y=ReportedIncidence,colour=RunNumber,group=RunNumber))+geom_path()+
       scale_colour_gradientn(colours=rainbow(12))+guides(color=FALSE)
```

